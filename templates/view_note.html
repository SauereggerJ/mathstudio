{% extends "base.html" %}

{% block title %}View Note - {{ filename }}{% endblock %}

{% block extra_head %}
<style>
    /* E-Ink Optimized Design - High Contrast, No Colors, No Shadows */

    .note-card {
        background: #ffffff;
        border: 1px solid #000000;
        border-radius: 0;
        margin-top: 1.5rem;
        overflow: hidden;
    }

    .latex-content {
        font-family: 'Inter', serif;
        line-height: 2;
        color: #000000;
        font-size: 1.2rem;
        white-space: pre-wrap;
        padding: 3rem;
    }

    .pdf-actions {
        padding: 3.5rem;
        text-align: center;
        background-color: #ffffff;
        border-bottom: 1px solid #000000;
    }

    .rec-item {
        padding: 1.5rem;
        border-bottom: 1px solid #000000;
        text-decoration: none;
        display: block;
        color: #000000;
    }

    .rec-item:last-child {
        border-bottom: none;
    }

    .rec-item:hover {
        background-color: #f5f5f5;
    }

    .rec-title {
        font-weight: 700;
        color: #000000;
        margin-bottom: 0.5rem;
        font-size: 1.1rem;
    }

    .rec-author {
        font-size: 1rem;
        color: #333333;
    }

    .rec-score {
        font-size: 0.9rem;
        background: #ffffff;
        color: #000000;
        padding: 0.375rem 0.75rem;
        border: 1px solid #000000;
        border-radius: 0;
        font-weight: 600;
        margin-left: 0.75rem;
    }

    .btn-action {
        width: 100%;
        margin-bottom: 0.75rem;
        text-align: left;
        font-size: 1.1rem;
        padding: 1rem;
        min-height: 50px;
    }

    /* Remove all transitions and animations for E-Ink */
    * {
        transition: none !important;
        animation: none !important;
    }

    /* High contrast buttons */
    .btn {
        border: 1px solid #000000;
        border-radius: 0;
        background: #ffffff;
        color: #000000;
        font-weight: 600;
        padding: 1rem 1.5rem;
        min-height: 50px;
    }

    .btn:hover {
        background: #000000;
        color: #ffffff;
    }

    .btn-primary {
        background: #ffffff;
        border: 2px solid #000000;
        color: #000000;
    }

    .btn-primary:hover {
        background: #000000;
        color: #ffffff;
    }

    .btn-outline-secondary,
    .btn-outline-dark,
    .btn-outline-primary,
    .btn-outline-danger {
        background: #ffffff;
        border: 1px solid #000000;
        color: #000000;
    }

    .btn-outline-secondary:hover,
    .btn-outline-dark:hover,
    .btn-outline-primary:hover,
    .btn-outline-danger:hover {
        background: #000000;
        color: #ffffff;
    }

    /* Larger touch targets */
    .btn-lg {
        font-size: 1.25rem;
        padding: 1.25rem 2rem;
        min-height: 60px;
    }

    .btn-sm {
        font-size: 1rem;
        padding: 0.75rem 1.25rem;
        min-height: 44px;
    }

    /* Card headers */
    .bg-light {
        background: #ffffff !important;
        border-bottom: 1px solid #000000;
    }

    .border-bottom {
        border-bottom: 1px solid #000000 !important;
    }

    .border-top {
        border-top: 1px solid #000000 !important;
    }

    /* Text colors */
    .text-success,
    .text-info,
    .text-primary,
    .text-danger,
    .text-secondary {
        color: #000000 !important;
    }

    .text-muted {
        color: #666666 !important;
    }

    /* Icons - ensure visibility */
    .fa,
    .fas,
    .far,
    .fab {
        color: inherit;
    }

    /* Breadcrumb */
    .breadcrumb {
        background: #ffffff;
        border: 1px solid #000000;
        border-radius: 0;
        padding: 1rem 1.5rem;
    }

    .breadcrumb-item a {
        color: #000000;
        text-decoration: underline;
    }

    .breadcrumb-item.active {
        color: #666666;
    }

    /* Alert boxes */
    .alert {
        border: 2px solid #000000;
        border-radius: 0;
        background: #ffffff;
        color: #000000;
        padding: 1.25rem;
    }

    /* Modal */
    #renameModal>div {
        background: #ffffff;
        border: 2px solid #000000;
        border-radius: 0;
        padding: 2.5rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Breadcrumb Navigation -->
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('index') }}"><i class="fas fa-home"></i> Home</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('list_notes') }}"><i class="fas fa-sticky-note"></i> Notes</a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">{{ filename }}</li>
    </ol>
</nav>

<div class="d-flex justify-content-between align-items-start mb-4">
    <div class="flex-grow-1">
        <h2 class="mb-2">{{ filename.replace('.tex', '') }}</h2>
        <div class="d-flex gap-3 text-muted small">
            <span><i class="far fa-calendar"></i> Processed Note</span>
            {% if has_pdf %}
            <span class="text-success"><i class="fas fa-check-circle"></i> PDF Available</span>
            {% endif %}
            {% if has_markdown %}
            <span class="text-info"><i class="fab fa-markdown"></i> Markdown Available</span>
            {% endif %}
        </div>
    </div>
    <div class="d-flex gap-2">
        <a href="{{ url_for('list_notes') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back to List
        </a>
    </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
{% for category, message in messages %}
<div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endfor %}
{% endif %}
{% endwith %}

<div class="row">
    <!-- Main Content Column -->
    <div class="col-md-8">
        <div class="note-card mb-4">
            {% if has_pdf %}
            <div class="pdf-actions">
                <i class="fas fa-file-pdf fa-3x text-danger mb-3"></i>
                <h4 class="mb-3">PDF Ready</h4>
                <a href="{{ url_for('serve_note', filename=pdf_filename) }}" target="_blank"
                    class="btn btn-primary btn-lg">
                    <i class="fas fa-external-link-alt"></i> Open PDF in New Tab
                </a>
            </div>
            {% else %}
            <div style="padding: 2.5rem;" class="bg-light border-bottom text-center">
                <i class="fas fa-cog fa-spin fa-2x text-muted mb-3"></i>
                <p class="text-muted">PDF processing or unavailable.</p>
            </div>
            {% endif %}

            <div class="p-3 bg-light d-flex justify-content-center gap-3 border-top">
                <a href="{{ url_for('serve_note', filename=filename) }}" class="btn btn-outline-secondary btn-sm"
                    download>
                    <i class="fas fa-download"></i> Download .tex
                </a>
                {% if has_markdown %}
                <a href="{{ url_for('serve_note', filename=markdown_filename) }}" class="btn btn-outline-dark btn-sm"
                    download>
                    <i class="fab fa-markdown"></i> Download .md
                </a>
                {% endif %}
                {% if has_pdf %}
                <a href="{{ url_for('serve_note', filename=pdf_filename) }}" class="btn btn-outline-primary btn-sm"
                    download>
                    <i class="fas fa-download"></i> Download PDF
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Sidebar Column -->
    <div class="col-md-4">
        <!-- Actions Card -->
        <div class="note-card mb-4">
            <div class="p-3 border-bottom bg-light">
                <h5 class="m-0"><i class="fas fa-tools me-2 text-secondary"></i>Actions</h5>
            </div>
            <div class="p-3">
                <button type="button" class="btn btn-outline-primary btn-action" onclick="showRenameModal()">
                    <i class="fas fa-edit me-2"></i> Rename Note
                </button>
                <button type="button" class="btn btn-outline-danger btn-action"
                    onclick="if(confirm('Are you sure you want to delete this note? This cannot be undone.')) { document.getElementById('delete-form').submit(); }">
                    <i class="fas fa-trash-alt me-2"></i> Delete Note
                </button>

                <form id="delete-form" action="{{ url_for('delete_note', filename=filename) }}" method="POST"
                    style="display: none;"></form>
            </div>
        </div>

        {% if recommendations %}
        <div class="note-card">
            <div class="p-3 border-bottom bg-light">
                <h5 class="m-0"><i class="fas fa-book-reader me-2 text-primary"></i>Recommended Reading</h5>
            </div>
            <div class="list-group list-group-flush">
                {% for rec in recommendations %}
                <a href="/book/{{ rec.id }}" class="rec-item">
                    <div class="d-flex justify-content-between">
                        <div class="rec-title">{{ rec.title }}</div>
                        <div><span class="rec-score">{{ (rec.score * 100)|round|int }}% Match</span></div>
                    </div>
                    <div class="rec-author">{{ rec.author }}</div>
                </a>
                {% endfor %}
            </div>
        </div>
        {% else %}
        <div class="note-card p-4 text-center text-muted">
            <small>Recommendations will appear here for new notes.</small>
        </div>
        {% endif %}
    </div>
</div>

<!-- Rename Modal -->
<div id="renameModal"
    style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 2rem; border-radius: 8px; width: 400px;">
        <h4>Rename Note</h4>
        <form action="{{ url_for('rename_note', filename=filename) }}" method="POST">
            <div class="mb-3">
                <label for="new_name" class="form-label">New Filename (no extension)</label>
                <input type="text" class="form-control" id="new_name" name="new_name"
                    value="{{ filename|replace('.tex', '') }}" required>
            </div>
            <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-secondary" onclick="hideRenameModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Rename</button>
            </div>
        </form>
    </div>
</div>

<script>
    function showRenameModal() {
        document.getElementById('renameModal').style.display = 'flex';
    }
    function hideRenameModal() {
        document.getElementById('renameModal').style.display = 'none';
    }
</script>

<!-- Hidden raw content for legacy/debug purposes if needed, but not rendered -->
<textarea id="raw-content" style="display:none;">{{ content }}</textarea>
{% endblock %}