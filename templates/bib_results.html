{% extends "base.html" %}

{% block title %}Bibliography Hunter Results{% endblock %}

{% block content %}
<div class="container" style="max-width: 1200px; margin: 40px auto; padding: 0 20px;">
    <h1 style="margin-bottom: 30px;">üìö Bibliography Hunter Results</h1>

    <!-- Book Info -->
    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
        <h2 style="margin-top: 0; font-size: 1.3em;">{{ book_title }}</h2>
        <p style="color: #666; margin: 5px 0;"><strong>Author:</strong> {{ book_author }}</p>
        <p style="color: #666; margin: 5px 0;"><strong>Bibliography Pages:</strong> {{ bib_pages|join(', ') }}</p>

        {% if extracted_pdf_path %}
        <div style="margin-top: 15px;">
            <a href="/api/v1/bib-extracts/{{ extracted_pdf_filename }}" target="_blank"
                style="display: inline-block; padding: 10px 20px; background: #007bff; color: white; text-decoration: none; border-radius: 5px;">
                üìÑ Download Bibliography Pages PDF
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Statistics -->
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
        <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 2em; font-weight: bold; color: #1976d2;">{{ stats.total }}</div>
            <div style="color: #666; margin-top: 5px;">Total Citations</div>
        </div>
        <div style="background: #e8f5e9; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 2em; font-weight: bold; color: #388e3c;">{{ stats.owned }}</div>
            <div style="color: #666; margin-top: 5px;">In Your Library</div>
        </div>
        <div style="background: #fff3e0; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 2em; font-weight: bold; color: #f57c00;">{{ stats.missing }}</div>
            <div style="color: #666; margin-top: 5px;">Missing</div>
        </div>
    </div>

    <!-- Tools Bar -->
    <div style="margin-bottom: 20px; text-align: right;">
        <button onclick="downloadMissing()" class="btn"
            style="background: #607d8b; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
            ‚¨áÔ∏è Download Missing Books
        </button>
    </div>

    <!-- Citations List -->
    <div style="margin-bottom: 30px;">
        <h3 style="margin-bottom: 20px;">Citations Found</h3>

        <div id="citations-container">
            {% for citation in citations %}
            <div class="citation-card" data-title="{{ citation.title }}" data-author="{{ citation.author }}"
                style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; 
                    {% if citation.status == 'owned' %}border-left: 4px solid #4caf50;{% else %}border-left: 4px solid #ff9800;{% endif %}">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <h4 style="margin: 0 0 5px 0; font-size: 1.1em; display: flex; align-items: center; gap: 8px;">
                            <span class="status-icon">{% if citation.status == 'owned' %}‚úÖ{% else %}‚ùå{% endif %}</span>
                            {{ citation.title }}
                        </h4>
                        <p style="color: #666; margin: 5px 0;">
                            <strong>Author:</strong> {{ citation.author }}
                        </p>

                        <div class="match-details" {% if citation.status !='owned' %}style="display: none;" {% endif %}>
                            {% if citation.status == 'owned' and citation.match %}
                            <div style="margin-top: 10px; padding: 10px; background: #f1f8f4; border-radius: 5px;">
                                <p style="margin: 0; font-size: 0.9em; color: #2e7d32;">
                                    <strong>Found in library:</strong> {{ citation.match.title }} by {{
                                    citation.match.author }}
                                </p>
                                <p style="margin: 5px 0 0 0; font-size: 0.85em; color: #666;">
                                    Match score: {{ (citation.match.score * 100)|round|int }}% | Strategy: {{
                                    citation.match.strategy }}
                                </p>
                                <a href="/book/{{ citation.match.id }}" target="_blank"
                                    style="color: #1976d2; text-decoration: none; font-size: 0.9em;">
                                    View in library ‚Üí
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <div
                        style="margin-left: 20px; display: flex; flex-direction: column; align-items: flex-end; gap: 10px;">
                        <span class="status-badge"
                            style="padding: 5px 12px; border-radius: 20px; font-size: 0.85em; white-space: nowrap;
                        color: white; background: {% if citation.status == 'owned' %}#4caf50{% else %}#ff9800{% endif %};">
                            {% if citation.status == 'owned' %}In Library{% else %}Missing{% endif %}
                        </span>

                        {% if citation.status != 'owned' %}
                        <button onclick="deepCheck(this)" class="deep-check-btn"
                            style="background: #5c6bc0; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85em; display: flex; align-items: center; gap: 5px;">
                            <span>üïµÔ∏è Deep Check</span>
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Back Button -->
    <div style="text-align: center; margin-top: 40px;">
        <button onclick="window.close()"
            style="padding: 12px 30px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1em;">
            ‚Üê Close Window
        </button>
    </div>
</div>

<script>
    async function deepCheck(btn) {
        const card = btn.closest('.citation-card');
        const title = card.dataset.title;
        const author = card.dataset.author;

        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = "Checking...";

        try {
            const response = await fetch('/api/v1/bib-extracts/check-citation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, author })
            });

            const data = await response.json();

            if (data.found) {
                // Update UI to show Found
                btn.remove(); // Remove Deep Check Button

                const badge = card.querySelector('.status-badge');
                badge.textContent = "Found (Deep Check)";
                badge.style.background = "#2e7d32"; // Darker green

                const icon = card.querySelector('.status-icon');
                icon.textContent = "‚úÖ";

                card.style.borderLeft = "4px solid #2e7d32";

                // Inject match details
                const detailsDiv = card.querySelector('.match-details');
                detailsDiv.style.display = 'block';
                detailsDiv.innerHTML = `
                <div style="margin-top: 10px; padding: 10px; background: #f1f8f4; border-radius: 5px;">
                    <p style="margin: 0; font-size: 0.9em; color: #2e7d32;">
                        <strong>Found:</strong> ${data.match.title}
                    </p>
                    <p style="margin: 5px 0 0 0; font-size: 0.85em; color: #666;">
                        Score: ${Math.round(data.match.score * 100)}% (Deep Scan)
                    </p>
                    <a href="/book/${data.match.id}" target="_blank" style="color: #1976d2; text-decoration: none; font-size: 0.9em;">
                        View in library ‚Üí
                    </a>
                </div>
            `;

                // Update stats counters if possible
                const missingCount = document.getElementById('bibMissing');
                const ownedCount = document.getElementById('bibOwned');
                if (missingCount && ownedCount) {
                    missingCount.textContent = parseInt(missingCount.textContent) - 1;
                    ownedCount.textContent = parseInt(ownedCount.textContent) + 1;
                }

            } else {
                alert("Deep Check: Still not found in library.");
                btn.innerHTML = "checked";
            }
        } catch (e) {
            alert("Error: " + e);
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    function downloadMissing() {
        // Collect all missing books from the DOM
        const cards = document.querySelectorAll('.citation-card');
        let text = "";

        cards.forEach(card => {
            // Check if currently missing (might have been found by deep check)
            const badge = card.querySelector('.status-badge');
            if (badge.textContent.includes('Missing')) {
                const title = card.dataset.title;
                const author = card.dataset.author;
                text += `${author}: ${title}\n`;
            }
        });

        if (!text) {
            alert("No missing books to download!");
            return;
        }

        const blob = new Blob([text], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'missing_books.txt';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    }
</script>
{% endblock %}